// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  OWNER
  ADMIN
  INVENTORY_MANAGER
  SALES_MANAGER
  TAILOR
  VIEWER
}

enum OrderStatus {
  NEW
  MATERIAL_SELECTED
  CUTTING
  STITCHING
  FINISHING
  READY
  DELIVERED
  CANCELLED
}

enum OrderPriority {
  NORMAL
  URGENT
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertType {
  LOW_STOCK
  CRITICAL_STOCK
  ORDER_DELAYED
  REORDER_REMINDER
}

enum StockMovementType {
  PURCHASE
  ORDER_RESERVED
  ORDER_USED
  ORDER_CANCELLED
  ADJUSTMENT
  RETURN
  WASTAGE
}

enum BodyType {
  SLIM
  REGULAR
  LARGE
  XL
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  TRANSPORT
  MARKETING
  MAINTENANCE
  OFFICE_SUPPLIES
  PROFESSIONAL_FEES
  INSURANCE
  DEPRECIATION
  BANK_CHARGES
  MISCELLANEOUS
}

enum PaymentMode {
  CASH
  UPI
  CARD
  BANK_TRANSFER
  CHEQUE
  NET_BANKING
}

enum DesignFileCategory {
  SKETCH            // Rough paper design
  REFERENCE         // Reference image
  WORK_IN_PROGRESS  // WIP photos
  FINAL             // Final product photo
}

// Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(VIEWER)
  phone         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  orders        Order[]
  stockMovements StockMovement[]
  orderHistory  OrderHistory[]
  measurements  Measurement[]
  uploadHistory UploadHistory[]
  expenses      Expense[]
  designUploads DesignUpload[]
  assignedOrderItems OrderItem[] @relation("OrderItemAssignedTailor")
}

model ClothInventory {
  id            String    @id @default(cuid())
  sku           String    @unique
  name          String
  brand         String
  color         String
  colorHex      String    // For UI display
  pattern       String    // Plain, Striped, Checkered, etc.
  quality       String    // Premium, Standard, Economy
  type          String    // Cotton, Silk, Linen, etc.
  pricePerMeter Float
  currentStock  Float     // in meters
  totalPurchased Float    @default(0) // Track total ever purchased
  reserved      Float     @default(0) // Reserved for orders
  minimum       Float     // Minimum stock level
  supplier      String
  supplierId    String?
  location      String?   // Storage location
  notes         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  orderItems    OrderItem[]
  stockMovements StockMovement[]
  supplierRel   Supplier? @relation(fields: [supplierId], references: [id])
  supplierPrices SupplierPrice[]

  @@index([sku])
  @@index([active])
  @@index([currentStock])
}

model AccessoryInventory {
  id            String    @id @default(cuid())
  sku           String    @unique
  name          String
  type          String    // Button, Thread, Zipper, etc.
  color         String?
  currentStock  Int
  minimum       Int
  pricePerUnit  Float
  supplier      String?
  supplierId    String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  garmentAccessories GarmentAccessory[]
  supplierRel   Supplier? @relation(fields: [supplierId], references: [id])

  @@index([active])
  @@index([sku])
}

model Customer {
  id            String    @id @default(cuid())
  name          String
  email         String?
  phone         String
  address       String?
  city          String?
  state         String?
  pincode       String?
  notes         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // GST fields
  gstin         String?   // GST Identification Number (for B2B customers)
  customerType  String    @default("B2C") // B2B or B2C

  // Relations
  orders        Order[]
  measurements  Measurement[]
  whatsappMessages WhatsAppMessage[]

  @@index([phone])
  @@index([active])
}

model Measurement {
  id            String    @id @default(cuid())
  customerId    String
  userId        String?   // Who created this measurement (for audit trail)
  garmentType   String    // Shirt, Trouser, Suit, Sherwani
  bodyType      BodyType? // Body type for this measurement

  // Common measurements (in cm)
  neck          Float?
  chest         Float?
  waist         Float?
  hip           Float?
  shoulder      Float?
  sleeveLength  Float?
  shirtLength   Float?
  inseam        Float?
  outseam       Float?
  thigh         Float?
  knee          Float?
  bottomOpening Float?
  jacketLength  Float?
  lapelWidth    Float?

  // Additional measurements as JSON for flexibility
  additionalMeasurements Json?

  // History tracking
  replacesId    String?   // ID of the measurement this replaces (for version history)
  isActive      Boolean   @default(true) // Current active version

  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdBy     User?     @relation(fields: [userId], references: [id])
  orders        Order[]
  orderItems    OrderItem[]

  // Self-referencing for history
  replaces      Measurement?  @relation("MeasurementHistory", fields: [replacesId], references: [id], onDelete: SetNull)
  replacedBy    Measurement[] @relation("MeasurementHistory")

  @@index([customerId])
  @@index([garmentType])
  @@index([userId])
  @@index([replacesId])
  @@index([isActive])
}

model GarmentPattern {
  id            String    @id @default(cuid())
  name          String    // Men's Shirt, Men's Trouser, etc.
  description   String?
  baseMeters    Float     // Base fabric requirement

  // Body type adjustments (additional meters needed)
  slimAdjustment     Float @default(0)
  regularAdjustment  Float @default(0)
  largeAdjustment    Float @default(0.3)
  xlAdjustment       Float @default(0.5)

  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accessories   GarmentAccessory[]
  orderItems    OrderItem[]

  @@index([active])
}

model GarmentAccessory {
  id              String    @id @default(cuid())
  garmentPatternId String
  accessoryId     String
  quantity        Int       // How many units needed per garment

  // Relations
  garmentPattern  GarmentPattern    @relation(fields: [garmentPatternId], references: [id], onDelete: Cascade)
  accessory       AccessoryInventory @relation(fields: [accessoryId], references: [id])

  @@unique([garmentPatternId, accessoryId])
}

model Order {
  id              String       @id @default(cuid())
  orderNumber     String       @unique
  customerId      String
  userId          String       // Who created the order
  measurementId   String?

  status          OrderStatus  @default(NEW)
  priority        OrderPriority @default(NORMAL)

  deliveryDate    DateTime
  orderDate       DateTime     @default(now())
  completedDate   DateTime?

  totalAmount     Float
  advancePaid     Float        @default(0)
  discount        Float        @default(0)   // Discount given by owner
  discountReason  String?                    // Reason for discount
  balanceAmount   Float

  // GST fields
  subTotal        Float        @default(0)   // Amount before GST
  gstRate         Float        @default(0)   // 5%, 12%, 18%, or 28%
  cgst            Float        @default(0)   // Central GST (intra-state)
  sgst            Float        @default(0)   // State GST (intra-state)
  igst            Float        @default(0)   // Integrated GST (inter-state)
  gstAmount       Float        @default(0)   // Total GST charged
  taxableAmount   Float        @default(0)   // Base for GST calculation

  // Invoice details
  invoiceNumber   String?      @unique       // GST invoice number
  invoiceDate     DateTime?                  // GST invoice date
  placeOfSupply   String?                    // State for GST

  notes           String?   // Customer instructions and special requests
  tailorNotes     String?   // Tailor's observations and modifications (separate from customer notes)
  active          Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  customer        Customer     @relation(fields: [customerId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  measurement     Measurement? @relation(fields: [measurementId], references: [id])
  items           OrderItem[]
  stockMovements  StockMovement[]
  history         OrderHistory[]
  installments    PaymentInstallment[]
  whatsappMessages WhatsAppMessage[]

  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([deliveryDate])
  @@index([invoiceDate])
}

model OrderHistory {
  id              String    @id @default(cuid())
  orderId         String
  userId          String    // Who made the change
  changeType      String    // STATUS_UPDATE, ORDER_EDIT, ITEM_ADDED, ITEM_REMOVED, etc.
  fieldName       String?   // Field that was changed (status, deliveryDate, etc.)
  oldValue        String?   // Previous value (JSON string for complex data)
  newValue        String?   // New value (JSON string for complex data)
  description     String    // Human-readable description of the change
  createdAt       DateTime  @default(now())

  // Relations
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([createdAt])
}

enum InstallmentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model PaymentInstallment {
  id                String            @id @default(cuid())
  orderId           String
  order             Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  installmentNumber Int               // 1, 2, 3, etc.
  amount            Float             // Expected installment amount
  dueDate           DateTime
  paidDate          DateTime?
  paidAmount        Float             @default(0)

  paymentMode       PaymentMode?
  transactionRef    String?           // Transaction ID or cheque number

  status            InstallmentStatus @default(PENDING)
  notes             String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([orderId])
  @@index([dueDate])
  @@index([status])
  @@index([paidDate])
}

model OrderItem {
  id                String    @id @default(cuid())
  orderId           String
  garmentPatternId  String
  clothInventoryId  String
  measurementId     String?   // Which measurement was used for this item
  assignedTailorId  String?   // Which tailor is assigned to this item

  quantity          Int       @default(1)
  bodyType          BodyType  @default(REGULAR)

  // Material calculations
  estimatedMeters   Float     // Calculated based on pattern and body type
  actualMetersUsed  Float?    // Recorded after cutting
  wastage           Float?    // Actual - Estimated

  pricePerUnit      Float
  totalPrice        Float

  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  garmentPattern    GarmentPattern @relation(fields: [garmentPatternId], references: [id])
  clothInventory    ClothInventory @relation(fields: [clothInventoryId], references: [id])
  measurement       Measurement? @relation(fields: [measurementId], references: [id])
  assignedTailor    User?     @relation("OrderItemAssignedTailor", fields: [assignedTailorId], references: [id])
  designUploads     DesignUpload[]

  @@index([orderId])
  @@index([measurementId])
  @@index([assignedTailorId])
}

model StockMovement {
  id              String            @id @default(cuid())
  clothInventoryId String
  orderId         String?
  userId          String

  type            StockMovementType
  quantity        Float             // Positive for additions, negative for reductions
  balanceAfter    Float             // Stock balance after this movement

  notes           String?
  createdAt       DateTime          @default(now())

  // Relations
  clothInventory  ClothInventory    @relation(fields: [clothInventoryId], references: [id])
  order           Order?            @relation(fields: [orderId], references: [id])
  user            User              @relation(fields: [userId], references: [id])

  @@index([clothInventoryId])
  @@index([orderId])
  @@index([createdAt])
}

model Supplier {
  id            String    @id @default(cuid())
  name          String
  contactPerson String?
  email         String?
  phone         String
  address       String?
  city          String?
  state         String?
  pincode       String?
  gstin         String?
  rating        Float     @default(0)
  notes         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  clothInventory      ClothInventory[]
  accessoryInventory  AccessoryInventory[]
  supplierPrices      SupplierPrice[]
  purchaseOrders      PurchaseOrder[]

  @@index([active])
}

model SupplierPrice {
  id              String    @id @default(cuid())
  supplierId      String
  clothInventoryId String
  pricePerMeter   Float
  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())

  // Relations
  supplier        Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  clothInventory  ClothInventory  @relation(fields: [clothInventoryId], references: [id])

  @@index([supplierId])
  @@index([clothInventoryId])
  @@index([effectiveFrom])
}

model PurchaseOrder {
  id            String    @id @default(cuid())
  poNumber      String    @unique
  supplierId    String
  orderDate     DateTime  @default(now())
  expectedDate  DateTime?
  receivedDate  DateTime?

  totalAmount   Float
  paidAmount    Float     @default(0)
  balanceAmount Float

  // GST fields
  subTotal        Float     @default(0)
  gstRate         Float     @default(0)
  cgst            Float     @default(0)
  sgst            Float     @default(0)
  igst            Float     @default(0)
  gstAmount       Float     @default(0)

  // Input Tax Credit tracking
  isInputTaxCredit Boolean  @default(true)  // Eligible for ITC
  itcClaimed      Boolean   @default(false) // ITC claimed in returns

  // Invoice details
  supplierInvoiceNumber String?
  supplierInvoiceDate   DateTime?

  status        String    @default("PENDING") // PENDING, RECEIVED, PARTIAL, CANCELLED
  notes         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  items         POItem[]

  @@index([poNumber])
  @@index([supplierId])
  @@index([status])
}

model POItem {
  id                String    @id @default(cuid())
  purchaseOrderId   String
  itemName          String
  itemType          String    // CLOTH, ACCESSORY
  quantity          Float
  unit              String    // meters, pieces
  pricePerUnit      Float
  totalPrice        Float
  receivedQuantity  Float     @default(0)
  createdAt         DateTime  @default(now())

  // Relations
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
}

model Alert {
  id            String        @id @default(cuid())
  type          AlertType
  severity      AlertSeverity
  title         String
  message       String
  relatedId     String?       // ID of related entity (inventory, order, etc.)
  relatedType   String?       // Type of related entity ('cloth', 'accessory', 'order', etc.)
  isRead        Boolean       @default(false)
  isDismissed   Boolean       @default(false)
  dismissedUntil DateTime?    // When the alert should reappear (null = not dismissed)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([isRead])
  @@index([isDismissed])
  @@index([dismissedUntil])
  @@index([createdAt])
  @@index([severity])
  @@unique([relatedId, relatedType, type, isDismissed]) // Prevent duplicate alerts for same item
}

model Settings {
  id            String    @id @default(cuid())
  key           String    @unique
  value         String
  description   String?
  updatedAt     DateTime  @updatedAt

  @@index([key])
}

model UploadHistory {
  id              String    @id @default(cuid())
  userId          String    // Who uploaded
  filename        String    // Original filename
  totalRecords    Int       // Total records in upload
  successCount    Int       // Successfully uploaded
  failureCount    Int       // Failed records
  duplicateCount  Int       // Duplicates found
  skippedCount    Int       // Skipped due to corruption

  status          String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, FAILED, CANCELLED

  // Detailed results
  successDetails  Json?     // Array of successfully uploaded record IDs
  failureDetails  Json?     // Array of failure messages with row numbers
  duplicateDetails Json?    // Array of duplicate records with confirmation status

  // Summary report
  summary         String?   // Human-readable summary

  // Timing
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startedAt])
}

model Expense {
  id              String          @id @default(cuid())
  category        ExpenseCategory
  description     String
  amount          Float                      // Amount before GST
  gstAmount       Float           @default(0)
  gstRate         Float           @default(0)
  totalAmount     Float                      // amount + gstAmount

  expenseDate     DateTime        @default(now())
  vendorName      String?
  vendorGstin     String?
  invoiceNumber   String?

  paymentMode     PaymentMode     @default(CASH)
  paidBy          String                     // User ID
  paidByUser      User            @relation(fields: [paidBy], references: [id])

  // Tax deduction tracking
  tdsAmount       Float           @default(0)  // TDS deducted (if applicable)
  tdsRate         Float           @default(0)  // TDS rate %

  // Recurring expense support
  isRecurring     Boolean         @default(false)
  recurringPeriod String?                    // MONTHLY, QUARTERLY, YEARLY

  notes           String?
  attachments     Json?                      // Store file paths/URLs

  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([category])
  @@index([expenseDate])
  @@index([paidBy])
  @@index([createdAt])
}

model BusinessSettings {
  id              String   @id @default(cuid())
  businessName    String
  gstin           String   @unique           // Business GST number
  state           String                      // State for CGST/SGST calculation
  address         String?
  city            String?
  pincode         String?
  phone           String?
  email           String?

  // Default GST rates for different items
  fabricGstRate   Float    @default(5)       // Default GST for fabrics
  garmentGstRate  Float    @default(12)      // Default GST for readymade garments

  // Financial year settings
  fyStartMonth    Int      @default(4)       // April = 4 (Indian FY)

  // Invoice settings
  invoicePrefix   String   @default("INV")
  invoiceCounter  Int      @default(1)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([gstin])
}

model DesignUpload {
  id              String              @id @default(cuid())
  orderItemId     String

  fileName        String              // Original filename
  fileType        String              // MIME type (image/jpeg, application/pdf, etc.)
  filePath        String              // Storage path relative to uploads directory
  fileSize        Int                 // Size in bytes

  category        DesignFileCategory  @default(SKETCH)
  description     String?

  uploadedBy      String              // User ID
  uploadedAt      DateTime            @default(now())

  // Relations
  orderItem       OrderItem           @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [uploadedBy], references: [id])

  @@index([orderItemId])
  @@index([uploadedBy])
  @@index([uploadedAt])
}

// WhatsApp Integration Models
model WhatsAppMessage {
  id            String    @id @default(cuid())
  recipient     String    // Phone number (E.164 format)
  customerId    String?
  orderId       String?
  messageType   String    // ORDER_CONFIRMATION, ORDER_READY, PAYMENT_REMINDER, CUSTOM, etc.
  templateName  String?
  content       String    @db.Text
  status        String    @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failureReason String?
  metadata      Json?     // Additional data (variables used, API response, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  order         Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([recipient])
}

model WhatsAppTemplate {
  id            String    @id @default(cuid())
  name          String    @unique
  category      String    // TRANSACTIONAL, MARKETING, UTILITY
  language      String    @default("en")
  content       String    @db.Text
  variables     Json      // Array of variable placeholders (e.g., ["customer_name", "order_number"])
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([name])
  @@index([active])
  @@index([category])
}
